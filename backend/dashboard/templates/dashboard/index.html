{% extends 'base.html' %}

{% block content %}
    <header>
        <div>
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <p style="color: var(--gray-text);">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            
        </div>
    </header>

    <div class="stats-grid">
        <div class="card">
            <h3>{{ total_count }}</h3>
            <p style="color: var(--gray-text);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©</p>
        </div>
        <div class="card">
            <h3>{{ clusters.count }}</h3>
            <p style="color: var(--gray-text);">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ (Clusters)</p>
        </div>
    </div>

    <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
    
         <div class="card">
                <h3 style="font-size: 18px; margin-bottom: 15px;">ğŸ“Š Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h3>
                <div style="height: 250px; position: relative;">
                <canvas id="sourcesChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3 style="font-size: 18px; margin-bottom: 15px;">ğŸ“ˆ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3>
        <div style="height: 250px; position: relative;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    </div>

    <div class="card">
        <h3>Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</th>
                    <th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th>
                    <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                    <th>Ø§Ù„Ø«Ù‚Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody>
                {% for item in clusters %}
                <tr>
                    <td>{{ item.title }}</td>
                    <td>{{ item.count }}</td>
                    <td><span class="badge badge-blue">{{ item.source }}</span></td>
                    <td>
    <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 12px; font-weight: bold; width: 30px;">{{ item.confidence }}%</span>
        <div style="flex: 1; height: 6px; background: #eee; border-radius: 10px; min-width: 60px;">
            <div style="width: {{ item.confidence }}%; height: 100%; border-radius: 10px; 
                        background: {% if item.confidence > 80 %}#00b894{% elif item.confidence > 60 %}#fdcb6e{% else %}#ff7675{% endif %};">
            </div>
        </div>
    </div>
</td>
                    <td>
                        <a href="{% url 'dashboard:generator' %}?id={{ item.id }}" class="action-btn">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> ØªÙˆÙ„ÙŠØ¯ Ø­Ù„
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.. Ø£Ø¶ÙÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´ØªØ±ÙƒØ© Ù„Ù„Ø£Ù„ÙˆØ§Ù†
    Chart.defaults.color = '#666';
    Chart.defaults.font.family = 'Tajawal';

    // 1. Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± (Doughnut)
    const ctxSources = document.getElementById('sourcesChart').getContext('2d');
    new Chart(ctxSources, {
        type: 'doughnut',
        data: {
            labels: ['ØªÙˆÙŠØªØ±', 'Ø´Ø§Øª Ø¨ÙˆØª', 'Ù…Ø±ÙƒØ² Ø§Ù„Ø§ØªØµØ§Ù„', 'Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'],
            datasets: [{
                data: [45, 25, 20, 10], // Ø£Ø±Ù‚Ø§Ù… ÙˆÙ‡Ù…ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹
                backgroundColor: [
                    '#6c5ce7', // Ø¨Ù†ÙØ³Ø¬ÙŠ ØºØ§Ù…Ù‚
                    '#00cec9', // ØªØ±ÙƒÙˆØ§Ø²ÙŠ
                    '#fd79a8', // ÙˆØ±Ø¯ÙŠ
                    '#ffeaa7'  // Ø£ØµÙØ±
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { font: { size: 12 } } }
            }
        }
    });

    // 2. Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ØªØ±Ù†Ø¯ (Line)
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ù„Ù„Ø®Ù„ÙÙŠØ©
    let gradient = ctxTrend.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(108, 92, 231, 0.5)'); // Ù„ÙˆÙ† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    gradient.addColorStop(1, 'rgba(108, 92, 231, 0.0)'); // Ù„ÙˆÙ† Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'],
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰',
                data: [12, 19, 15, 25, 22, 30, 45],
                borderColor: '#6c5ce7',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4, // Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø· Ù…Ù†Ø­Ù†ÙŠ ÙˆÙ†Ø§Ø¹Ù…
                pointRadius: 4,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#6c5ce7'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}